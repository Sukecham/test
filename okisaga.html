<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>éš å²æµ·ä¼èª¬</title>
    <style>
      body { margin: 0; background: #000; }
    </style>
  </head>
  <body>
    <div id="root"></div>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="text/babel">
const { useState, useCallback, useEffect, useRef } = React;

// åŠ¹æœéŸ³ç”Ÿæˆ
const useSound = () => {
const audioCtx = useRef(null);

const getCtx = () => {
if (!audioCtx.current) {
audioCtx.current = new (window.AudioContext || window.webkitAudioContext)();
}
return audioCtx.current;
};

const play = (type) => {
try {
const ctx = getCtx();
const osc = ctx.createOscillator();
const gain = ctx.createGain();
osc.connect(gain);
gain.connect(ctx.destination);

  switch (type) {
    case 'attack':
      osc.frequency.setValueAtTime(200, ctx.currentTime);
      osc.frequency.exponentialRampToValueAtTime(100, ctx.currentTime + 0.1);
      gain.gain.setValueAtTime(0.3, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
      osc.start(); osc.stop(ctx.currentTime + 0.1);
      break;
    case 'hit':
      osc.frequency.setValueAtTime(150, ctx.currentTime);
      osc.frequency.exponentialRampToValueAtTime(50, ctx.currentTime + 0.15);
      gain.gain.setValueAtTime(0.2, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.15);
      osc.start(); osc.stop(ctx.currentTime + 0.15);
      break;
    case 'critical':
      osc.type = 'sawtooth';
      osc.frequency.setValueAtTime(400, ctx.currentTime);
      osc.frequency.exponentialRampToValueAtTime(800, ctx.currentTime + 0.1);
      gain.gain.setValueAtTime(0.3, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.15);
      osc.start(); osc.stop(ctx.currentTime + 0.15);
      break;
    case 'win':
      osc.type = 'sine';
      [523, 659, 784, 1047].forEach((f, i) => {
        osc.frequency.setValueAtTime(f, ctx.currentTime + i * 0.12);
      });
      gain.gain.setValueAtTime(0.2, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
      osc.start(); osc.stop(ctx.currentTime + 0.5);
      break;
    case 'lose':
      osc.type = 'sine';
      osc.frequency.setValueAtTime(300, ctx.currentTime);
      osc.frequency.exponentialRampToValueAtTime(100, ctx.currentTime + 0.5);
      gain.gain.setValueAtTime(0.25, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
      osc.start(); osc.stop(ctx.currentTime + 0.5);
      break;
    case 'levelup':
      osc.type = 'sine';
      [440, 554, 659, 880].forEach((f, i) => {
        osc.frequency.setValueAtTime(f, ctx.currentTime + i * 0.1);
      });
      gain.gain.setValueAtTime(0.25, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
      osc.start(); osc.stop(ctx.currentTime + 0.5);
      break;
    case 'gacha':
      osc.type = 'triangle';
      osc.frequency.setValueAtTime(300, ctx.currentTime);
      osc.frequency.linearRampToValueAtTime(600, ctx.currentTime + 0.5);
      gain.gain.setValueAtTime(0.15, ctx.currentTime);
      gain.gain.linearRampToValueAtTime(0.3, ctx.currentTime + 0.5);
      gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.6);
      osc.start(); osc.stop(ctx.currentTime + 0.6);
      break;
    case 'gachaHit':
      osc.type = 'sine';
      [880, 1108, 1318, 1760].forEach((f, i) => {
        osc.frequency.setValueAtTime(f, ctx.currentTime + i * 0.08);
      });
      gain.gain.setValueAtTime(0.3, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.4);
      osc.start(); osc.stop(ctx.currentTime + 0.4);
      break;
    case 'gachaRare':
      osc.type = 'sine';
      for (let i = 0; i < 8; i++) {
        osc.frequency.setValueAtTime(600 + i * 100, ctx.currentTime + i * 0.06);
      }
      gain.gain.setValueAtTime(0.3, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.6);
      osc.start(); osc.stop(ctx.currentTime + 0.6);
      break;
    case 'button':
      osc.frequency.setValueAtTime(800, ctx.currentTime);
      gain.gain.setValueAtTime(0.1, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.05);
      osc.start(); osc.stop(ctx.currentTime + 0.05);
      break;
    case 'heal':
      osc.type = 'sine';
      osc.frequency.setValueAtTime(523, ctx.currentTime);
      osc.frequency.setValueAtTime(659, ctx.currentTime + 0.1);
      osc.frequency.setValueAtTime(784, ctx.currentTime + 0.2);
      gain.gain.setValueAtTime(0.2, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
      osc.start(); osc.stop(ctx.currentTime + 0.3);
      break;
    case 'boss':
      osc.type = 'sawtooth';
      osc.frequency.setValueAtTime(80, ctx.currentTime);
      osc.frequency.setValueAtTime(60, ctx.currentTime + 0.2);
      osc.frequency.setValueAtTime(80, ctx.currentTime + 0.4);
      gain.gain.setValueAtTime(0.3, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
      osc.start(); osc.stop(ctx.currentTime + 0.5);
      break;
    default:
      break;
  }
} catch (e) {}

};
return play;
};

// è·æ¥­å®šç¾©
const JOBS = {
fisherman: { name: 'æ¼å¸«', icon: 'ğŸ£', color: '#4169E1', baseAtk: 12, baseDef: 8, baseHp: 110, special: 'shell', rarity: 'N' },
salaryman: { name: 'ã‚µãƒ©ãƒªãƒ¼ãƒãƒ³', icon: 'ğŸ‘”', color: '#708090', baseAtk: 10, baseDef: 10, baseHp: 100, special: 'exp', rarity: 'N' },
sumo: { name: 'åŠ›å£«', icon: 'ğŸ¤¼', color: '#8B4513', baseAtk: 15, baseDef: 5, baseHp: 180, special: 'counter', rarity: 'R' },
doctor: { name: 'åŒ»è€…', icon: 'ğŸ‘¨â€âš•ï¸', color: '#00CED1', baseAtk: 8, baseDef: 12, baseHp: 100, special: 'heal', rarity: 'R' },
diver: { name: 'æµ·å¥³', icon: 'ğŸ¤¿', color: '#20B2AA', baseAtk: 14, baseDef: 6, baseHp: 90, special: 'crit', rarity: 'R' },
chef: { name: 'æ–™ç†äºº', icon: 'ğŸ‘¨â€ğŸ³', color: '#FF6347', baseAtk: 10, baseDef: 8, baseHp: 95, special: 'item', rarity: 'SR' },
shrine: { name: 'ç¥ä¸»', icon: 'â›©ï¸', color: '#9932CC', baseAtk: 11, baseDef: 11, baseHp: 105, special: 'divine', rarity: 'SR' },
captain: { name: 'èˆ¹é•·', icon: 'ğŸš¢', color: '#FFD700', baseAtk: 13, baseDef: 13, baseHp: 120, special: 'double', rarity: 'SSR' },
emperor: { name: 'å¾Œé³¥ç¾½ä¸Šçš‡', icon: 'ğŸ‘‘', color: '#FF4500', baseAtk: 18, baseDef: 15, baseHp: 150, special: 'pierce', rarity: 'SSR' },
dragon: { name: 'é¾ç¥', icon: 'ğŸ‰', color: '#00FF7F', baseAtk: 25, baseDef: 20, baseHp: 200, special: 'all', rarity: 'UR' },
};
const JOB_IDS = Object.keys(JOBS);

const SHELLS = {
1: { name: 'ã‚·ã‚¸ãƒŸ', color: '#8B7355', icon: 'ğŸš', itemCost: 10, jobCost: 15 },
2: { name: 'ã‚¢ã‚µãƒª', color: '#CD853F', icon: 'ğŸ¦ª', itemCost: 8, jobCost: 12 },
3: { name: 'ãƒãƒã‚°ãƒª', color: '#DAA520', icon: 'ğŸš', itemCost: 5, jobCost: 8 },
4: { name: 'ã‚µã‚¶ã‚¨', color: '#228B22', icon: 'ğŸš', itemCost: 3, jobCost: 5 },
5: { name: 'ã‚¢ãƒ¯ãƒ“', color: '#4169E1', icon: 'ğŸ¦ª', itemCost: 1, jobCost: 2 },
};

// æ•µå®šç¾©ï¼ˆé€šå¸¸ï¼‹ãƒœã‚¹ï¼‰- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ã¦ã‚¹ã‚±ãƒ¼ãƒ«
const ENEMIES = [
// é€šå¸¸æ•µ
{ name: 'ã‚¦ãƒ‹', hp: 30, atk: 8, def: 3, exp: 15, drop: [1,1,1,2], color: '#8B008B', icon: 'ğŸ¦”', lv: 1, boss: false },
{ name: 'ãƒ’ãƒˆãƒ‡', hp: 45, atk: 12, def: 4, exp: 25, drop: [1,2,2,2], color: '#FF6347', icon: 'â­', lv: 1, boss: false },
{ name: 'ã‚¯ãƒ©ã‚²', hp: 40, atk: 15, def: 2, exp: 20, drop: [1,1,2,2], color: '#FFB6C1', icon: 'ğŸª¼', lv: 2, boss: false },
{ name: 'ã‚¿ã‚³', hp: 80, atk: 22, def: 8, exp: 45, drop: [2,2,3,3], color: '#FF4500', icon: 'ğŸ™', lv: 5, boss: false },
{ name: 'ã‚«ãƒ‹', hp: 100, atk: 18, def: 20, exp: 55, drop: [2,2,3,3], color: '#DC143C', icon: 'ğŸ¦€', lv: 6, boss: false },
{ name: 'ã‚µãƒ¡', hp: 180, atk: 40, def: 15, exp: 120, drop: [3,3,4,4], color: '#4682B4', icon: 'ğŸ¦ˆ', lv: 10, boss: false },
{ name: 'ã‚¦ãƒŸã‚¬ãƒ¡', hp: 220, atk: 30, def: 35, exp: 130, drop: [3,4,4,4], color: '#2E8B57', icon: 'ğŸ¢', lv: 12, boss: false },
{ name: 'ã‚·ãƒ£ãƒ', hp: 280, atk: 55, def: 25, exp: 180, drop: [3,4,4,5], color: '#1C1C1C', icon: 'ğŸ‹', lv: 15, boss: false },
{ name: 'å¤§ç‹ã‚¤ã‚«', hp: 380, atk: 70, def: 30, exp: 250, drop: [4,4,5,5], color: '#800080', icon: 'ğŸ¦‘', lv: 20, boss: false },
{ name: 'ãƒ¡ã‚¬ãƒ­ãƒ‰ãƒ³', hp: 550, atk: 95, def: 45, exp: 400, drop: [4,5,5,5], color: '#696969', icon: 'ğŸ¦ˆ', lv: 28, boss: false },
{ name: 'æµ·åŠä¸»', hp: 750, atk: 110, def: 55, exp: 550, drop: [5,5,5,5], color: '#191970', icon: 'ğŸ‘¹', lv: 35, boss: false },
{ name: 'æµ·ç¥ãƒ¯ãƒ€ãƒ„ãƒŸ', hp: 1200, atk: 150, def: 80, exp: 1000, drop: [5,5,5,5], color: '#00CED1', icon: 'ğŸ”±', lv: 45, boss: false },

// ãƒœã‚¹æ•µï¼ˆè‰²é•ã„ãƒ»å¼·åŒ–ç‰ˆï¼‰
{ name: 'æ¯’ã‚­ãƒ³ã‚°ã‚¦ãƒ‹', hp: 80, atk: 20, def: 8, exp: 50, drop: [2,2,2,3], color: '#FF00FF', icon: 'ğŸ¦”', lv: 3, boss: true, glow: '#FF00FF' },
{ name: 'ç¼ç†±ãƒ’ãƒˆãƒ‡', hp: 120, atk: 30, def: 10, exp: 80, drop: [2,2,3,3], color: '#FF4500', icon: 'â­', lv: 5, boss: true, glow: '#FF4500' },
{ name: 'é›»æ’ƒã‚¯ãƒ©ã‚²', hp: 100, atk: 40, def: 5, exp: 70, drop: [2,3,3,3], color: '#00FFFF', icon: 'ğŸª¼', lv: 6, boss: true, glow: '#00FFFF' },
{ name: 'æ·±æµ·å¤§ãƒ€ã‚³', hp: 200, atk: 55, def: 18, exp: 150, drop: [3,3,4,4], color: '#8B0000', icon: 'ğŸ™', lv: 10, boss: true, glow: '#FF0000' },
{ name: 'é‹¼é‰„ã‚«ãƒ‹', hp: 250, atk: 45, def: 50, exp: 180, drop: [3,4,4,4], color: '#C0C0C0', icon: 'ğŸ¦€', lv: 12, boss: true, glow: '#FFFFFF' },
{ name: 'ç™½é¯¨ã‚·ãƒ£ãƒ¼ã‚¯', hp: 400, atk: 90, def: 35, exp: 350, drop: [4,4,5,5], color: '#F0F8FF', icon: 'ğŸ¦ˆ', lv: 18, boss: true, glow: '#87CEEB' },
{ name: 'ç„æ­¦', hp: 500, atk: 70, def: 80, exp: 400, drop: [4,4,5,5], color: '#006400', icon: 'ğŸ¢', lv: 22, boss: true, glow: '#00FF00' },
{ name: 'è¦‡ç‹ã‚·ãƒ£ãƒ', hp: 650, atk: 130, def: 50, exp: 550, drop: [4,5,5,5], color: '#4B0082', icon: 'ğŸ‹', lv: 28, boss: true, glow: '#9400D3' },
{ name: 'ã‚¯ãƒ©ãƒ¼ã‚±ãƒ³', hp: 900, atk: 160, def: 60, exp: 800, drop: [5,5,5,5], color: '#2F0040', icon: 'ğŸ¦‘', lv: 35, boss: true, glow: '#8B008B' },
{ name: 'å¤ä»£ãƒ¡ã‚¬ãƒ­ãƒ‰ãƒ³', hp: 1300, atk: 200, def: 80, exp: 1200, drop: [5,5,5,5], color: '#1a1a1a', icon: 'ğŸ¦ˆ', lv: 42, boss: true, glow: '#FFD700' },
{ name: 'æš´é¢¨æµ·åŠä¸»', hp: 1800, atk: 250, def: 100, exp: 1800, drop: [5,5,5,5], color: '#000033', icon: 'ğŸ‘¹', lv: 48, boss: true, glow: '#00BFFF' },
{ name: 'é¾å®®ã®ç‹', hp: 3000, atk: 350, def: 150, exp: 3000, drop: [5,5,5,5], color: '#FFD700', icon: 'ğŸ‘‘', lv: 55, boss: true, glow: '#FFD700' },
];

// éš å²ã‚‰ã—ã„è£…å‚™
const ITEMS = {
1: [
{ id: 'w1a', name: 'æ¼å¸«ã®éŠ›', type: 'W', rarity: 'N', atk: 3, def: 0, hp: 0 },
{ id: 'a1a', name: 'è—ç·¨ã¿ã®èƒ´ç€', type: 'A', rarity: 'N', atk: 0, def: 3, hp: 5 },
{ id: 'w1b', name: 'è²æ®»ã®å°åˆ€', type: 'W', rarity: 'R', atk: 5, def: 0, hp: 0 },
{ id: 'a1b', name: 'æµ·è—»ã®ç¾½ç¹”', type: 'A', rarity: 'R', atk: 0, def: 4, hp: 10 },
{ id: 'c1a', name: 'ç™½å³¶ã®è­·çŸ³', type: 'C', rarity: 'SR', atk: 3, def: 3, hp: 15 },
],
2: [
{ id: 'w2a', name: 'éš å²æ‰ã®æ£æ£’', type: 'W', rarity: 'N', atk: 6, def: 0, hp: 0 },
{ id: 'a2a', name: 'ç‰›çš®ã®èƒ¸å½“ã¦', type: 'A', rarity: 'N', atk: 0, def: 6, hp: 10 },
{ id: 'w2b', name: 'ã‚¤ã‚«é‡£ã‚Šã®é‰¤æ§', type: 'W', rarity: 'R', atk: 10, def: 0, hp: 0 },
{ id: 'a2b', name: 'ä¸­ãƒå³¶ã®æ¼å¸«åˆç¾½', type: 'A', rarity: 'R', atk: 0, def: 8, hp: 15 },
{ id: 'c2a', name: 'è¥¿éƒ·æ¹¾ã®çœŸç ', type: 'C', rarity: 'SR', atk: 5, def: 5, hp: 25 },
],
3: [
{ id: 'w3a', name: 'çŸ¥å¤«é‡Œã®é¯¨éª¨åˆ€', type: 'W', rarity: 'R', atk: 15, def: 0, hp: 0 },
{ id: 'a3a', name: 'ã‚µã‚¶ã‚¨æ®»ã®é§', type: 'A', rarity: 'R', atk: 0, def: 15, hp: 20 },
{ id: 'w3b', name: 'æµ·å£«ã®ä¸‰å‰æ§', type: 'W', rarity: 'SR', atk: 20, def: 0, hp: 0 },
{ id: 'a3b', name: 'ç‰›çªãã®åŒ–ç²§å»»ã—', type: 'A', rarity: 'SR', atk: 5, def: 12, hp: 30 },
{ id: 'c3a', name: 'ç‰è‹¥é…¢å‘½ã®å‹¾ç‰', type: 'C', rarity: 'SSR', atk: 10, def: 10, hp: 40 },
],
4: [
{ id: 'w4a', name: 'é»’æ›œçŸ³ã®å¤ªåˆ€', type: 'W', rarity: 'SR', atk: 30, def: 0, hp: 0 },
{ id: 'a4a', name: 'æ‘©å¤©å´–ã®å²©é§', type: 'A', rarity: 'SR', atk: 0, def: 30, hp: 35 },
{ id: 'w4b', name: 'åœ‹è³€ç¥ç¤¾ã®ç¥å‰£', type: 'W', rarity: 'SSR', atk: 40, def: 5, hp: 0 },
{ id: 'a4b', name: 'ç„¼ç«ç¥ç¤¾ã®ç¥è¡£', type: 'A', rarity: 'SSR', atk: 5, def: 35, hp: 50 },
{ id: 'c4a', name: 'ãƒ­ãƒ¼ã‚½ã‚¯å³¶ã®è–ç«', type: 'C', rarity: 'UR', atk: 20, def: 20, hp: 60 },
],
5: [
{ id: 'w5a', name: 'å¾Œé³¥ç¾½é™¢ã®å¾¡å‰£', type: 'W', rarity: 'SSR', atk: 50, def: 5, hp: 0 },
{ id: 'a5a', name: 'æ‰¿ä¹…ã®æˆ¦è£…æŸ', type: 'A', rarity: 'SSR', atk: 5, def: 50, hp: 60 },
{ id: 'w5b', name: 'é¾ç¥ã®ä¸‰å‰æˆŸ', type: 'W', rarity: 'UR', atk: 65, def: 10, hp: 20 },
{ id: 'a5b', name: 'éš å²å›½é€ ã®å¤§é§', type: 'A', rarity: 'UR', atk: 10, def: 60, hp: 80 },
{ id: 'c5a', name: 'å³¶å‰å³¶å¾Œã®ç¥ç’½', type: 'C', rarity: 'LR', atk: 40, def: 40, hp: 100 },
],
};
const ALL_ITEMS = Object.values(ITEMS).flat();

const RARITY_COLOR = { N: '#808080', R: '#4169E1', SR: '#9932CC', SSR: '#FFD700', UR: '#FF4500', LR: '#00FF7F' };
const RARITY_LIST = ['N', 'R', 'SR', 'SSR', 'UR', 'LR'];
const TYPE_ICON = { W: 'âš”ï¸', A: 'ğŸ›¡ï¸', C: 'ğŸ’' };
const TYPE_NAME = { W: 'æ­¦å™¨', A: 'é˜²å…·', C: 'è£…é£¾' };

const ITEM_RATES = { 1: [.4,.35,.25,0,0], 2: [.35,.35,.3,0,0], 3: [0,.35,.4,.25,0], 4: [0,0,.4,.45,.15], 5: [0,0,.3,.45,.25] };
const JOB_RATES = { 1: {N:.8,R:.18,SR:.02}, 2: {N:.6,R:.35,SR:.05}, 3: {N:.3,R:.5,SR:.18,SSR:.02}, 4: {N:.1,R:.3,SR:.45,SSR:.14,UR:.01}, 5: {R:.1,SR:.4,SSR:.4,UR:.1} };

const SPELL = 'ã‚ã„ã†ãˆãŠã‹ããã‘ã“ã•ã—ã™ã›ããŸã¡ã¤ã¦ã¨ãªã«ã¬ã­ã®ã¯ã²ãµã¸ã»ã¾ã¿ã‚€ã‚ã‚‚ã‚„ã‚†ã‚ˆã‚‰ã‚Šã‚‹ã‚Œã‚ã‚ã‚’ã‚“';

const encode = (p) => {
let d = [p.level, p.exp % 47, Math.floor(p.exp / 47) % 47, JOB_IDS.indexOf(p.currentJob)];
let jf = 0; p.unlockedJobs.forEach(j => jf |= 1 << JOB_IDS.indexOf(j)); d.push(jf % 47, Math.floor(jf / 47) % 47);
for (let i = 1; i <= 5; i++) d.push(p.shells[i] % 47);
JOB_IDS.forEach(j => d.push((p.jobLevels[j] || 1) - 1));
d.push(p.items.length);
p.items.forEach(it => { d.push(ALL_ITEMS.findIndex(x => x.id === it.id)); d.push((it.lv || 1) - 1); });
d.push(d.reduce((a, b) => a + b, 0) % 47);
return d.map(n => SPELL[n % 47]).join('');
};

const decode = (s) => {
try {
const c = s.replace(/\s/g, '').split('').map(x => SPELL.indexOf(x));
let i = 0;
const level = c[i++], exp = c[i++] + c[i++] * 47, currentJob = JOB_IDS[c[i++]];
const jf = c[i++] + c[i++] * 47;
const unlockedJobs = JOB_IDS.filter((_, idx) => jf & (1 << idx));
if (!unlockedJobs.includes('fisherman')) unlockedJobs.push('fisherman');
const shells = {}; for (let j = 1; j <= 5; j++) shells[j] = c[i++];
const jobLevels = {}; JOB_IDS.forEach(j => jobLevels[j] = c[i++] + 1);
const itemCount = c[i++], items = [];
for (let j = 0; j < itemCount; j++) { const it = ALL_ITEMS[c[i++]]; if (it) items.push({ ...it, lv: c[i++] + 1 }); else i++; }
return { level, exp, currentJob, unlockedJobs, shells, jobLevels, items };
} catch { return null; }
};

function Game() {
const [screen, setScreen] = useState('title');
const [player, setPlayer] = useState({
level: 1, exp: 0, currentJob: 'fisherman',
unlockedJobs: ['fisherman', 'salaryman'],
shells: { 1: 5, 2: 3, 3: 1, 4: 0, 5: 0 },
jobLevels: { fisherman: 1, salaryman: 1 },
items: [],
});
const [hp, setHp] = useState(null);
const [enemy, setEnemy] = useState(null);
const [log, setLog] = useState([]);
const [anim, setAnim] = useState(false);
const [tab, setTab] = useState('gacha');
const [gachaPhase, setGachaPhase] = useState(null);
const [gachaType, setGachaType] = useState(null);
const [gachaRank, setGachaRank] = useState(null);
const [gachaRarity, setGachaRarity] = useState(null);
const [result, setResult] = useState(null);
const [showPw, setShowPw] = useState(false);
const [pwInput, setPwInput] = useState('');
const [pwError, setPwError] = useState('');
const [showPwInput, setShowPwInput] = useState(false);

const sound = useSound();
const job = JOBS[player.currentJob];
const jLv = player.jobLevels[player.currentJob] || 1;
const jBonus = 1 + (jLv - 1) * 0.15;
const spBonus = 15 + (jLv - 1) * 8;

const getStats = useCallback(() => {
let atk = Math.floor((job.baseAtk + (player.level - 1) * 3) * jBonus);
let def = Math.floor((job.baseDef + (player.level - 1) * 2) * jBonus);
let mhp = Math.floor((job.baseHp + (player.level - 1) * 20) * jBonus);
player.items.forEach(it => {
const b = 1 + ((it.lv || 1) - 1) * 0.25;
atk += Math.floor(it.atk * b);
def += Math.floor(it.def * b);
mhp += Math.floor(it.hp * b);
});
if (job.special === 'item' || job.special === 'all') { atk = Math.floor(atk * (1 + spBonus / 100)); def = Math.floor(def * (1 + spBonus / 100)); }
if (job.special === 'divine' || job.special === 'all') { atk = Math.floor(atk * 1.1); def = Math.floor(def * 1.1); mhp = Math.floor(mhp * 1.1); }
return { atk, def, mhp };
}, [player, job, jBonus, spBonus]);

const stats = getStats();
const maxHp = stats.mhp;
const curHp = hp ?? maxHp;

useEffect(() => { if (hp === null) setHp(maxHp); }, [hp, maxHp]);

const expNext = (lv) => Math.floor(lv * 50 * (1 + lv * 0.1));

// æ•µã®ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ã¦å¼·åŒ–ï¼‰
const scaleEnemy = (base, playerLv) => {
const lvDiff = playerLv - base.lv;
const scale = 1 + Math.max(0, lvDiff) * 0.12; // ãƒ¬ãƒ™ãƒ«å·®1ã«ã¤ã12%å¼·åŒ–
const bossScale = base.boss ? 1.5 : 1; // ãƒœã‚¹ã¯1.5å€
return {
...base,
maxHp: Math.floor(base.hp * scale * bossScale),
hp: Math.floor(base.hp * scale * bossScale),
atk: Math.floor(base.atk * scale * bossScale),
def: Math.floor(base.def * scale * bossScale),
exp: Math.floor(base.exp * scale * (base.boss ? 2 : 1)),
};
};

const startBattle = () => {
sound('button');
if (curHp <= 0) setHp(maxHp);

// ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ãŸæ•µã‚’é¸æŠï¼ˆãƒœã‚¹20%å‡ºç¾ï¼‰
const isBoss = Math.random() < 0.2;
const availEnemies = ENEMIES.filter(e => e.boss === isBoss && e.lv <= player.level + 8 && e.lv >= player.level - 10);
const fallback = ENEMIES.filter(e => e.boss === isBoss);
const pool = availEnemies.length > 0 ? availEnemies : fallback;
const base = pool[Math.floor(Math.random() * pool.length)];
const scaled = scaleEnemy(base, player.level);

if (scaled.boss) sound('boss');
setEnemy(scaled);
setLog([`${scaled.boss ? 'âš ï¸ BOSS! ' : ''}${scaled.name}ãŒç¾ã‚ŒãŸï¼`]);
setScreen('battle');

};

const doAttack = () => {
if (!enemy || anim) return;
setAnim(true);
sound('attack');

const sp = job.special;
let dmg = Math.max(1, stats.atk - Math.floor(enemy.def / ((sp === 'pierce' || sp === 'all') ? 3 : 2)));
const isCrit = Math.random() < ((sp === 'crit' || sp === 'all') ? spBonus / 100 : 0.05);
if (isCrit) { dmg = Math.floor(dmg * 1.5); sound('critical'); }
const bonus = Math.random() < ((sp === 'double' || sp === 'all') ? spBonus / 100 : 0) ? Math.floor(dmg * 0.5) : 0;
const eDmg = Math.max(1, enemy.atk - Math.floor(stats.def / 2));
const reflect = Math.floor(eDmg * ((sp === 'counter' || sp === 'all') ? spBonus / 100 : 0));
const heal = Math.floor(maxHp * ((sp === 'heal' || sp === 'all') ? spBonus / 200 : 0));
const newEHp = Math.max(0, enemy.hp - dmg - bonus - reflect);
const newHp = Math.min(maxHp, Math.max(0, curHp - eDmg + heal));

const newLog = [...log];
newLog.push(`${isCrit ? 'ğŸ’¥ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«! ' : ''}${dmg}${bonus > 0 ? `+${bonus}` : ''}ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`);
if (reflect > 0) newLog.push(`ğŸ”„åå°„${reflect}ï¼`);

if (newEHp <= 0) {
  sound('win');
  let rank = enemy.drop[Math.floor(Math.random() * enemy.drop.length)];
  if (Math.random() < ((sp === 'shell' || sp === 'all') ? spBonus / 100 : 0)) rank = Math.min(5, rank + 1);
  const expRate = (sp === 'exp' || sp === 'all') ? 1 + spBonus / 100 : 1;
  const expG = Math.floor(enemy.exp * expRate);
  let [nExp, nLv] = [player.exp + expG, player.level];
  while (nExp >= expNext(nLv)) { nExp -= expNext(nLv); nLv++; }
  newLog.push(`ğŸ‰å‹åˆ©ï¼ ${SHELLS[rank].icon}${SHELLS[rank].name}+1 ğŸ’«${expG}EXP`);
  if (nLv > player.level) { newLog.push(`â¬†ï¸ Lv${nLv}ã«ã‚¢ãƒƒãƒ—ï¼`); sound('levelup'); }
  setPlayer(p => ({ ...p, shells: { ...p.shells, [rank]: p.shells[rank] + 1 }, exp: nExp, level: nLv }));
  setHp(nLv > player.level ? getStats().mhp : newHp);
  setEnemy(null);
} else {
  setTimeout(() => sound('hit'), 200);
  newLog.push(`${enemy.name}ã®åæ’ƒï¼ ${eDmg}ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼${heal > 0 ? ` ğŸ’š+${heal}` : ''}`);
  if (newHp <= 0) { newLog.push('ğŸ’€æ•—åŒ—...'); sound('lose'); setHp(0); setEnemy(null); }
  else { setEnemy(e => ({ ...e, hp: newEHp })); setHp(newHp); }
}
setLog(newLog.slice(-5));
setTimeout(() => setAnim(false), 200);

};

const getTiming = (r) => {
const i = RARITY_LIST.indexOf(r);
return { spin: 1000 + i * 200, build: i >= 2 ? 1000 + i * 500 : 0 };
};

const pullItem = (rank) => {
if (player.shells[rank] < SHELLS[rank].itemCost) return;
sound('gacha');
setPlayer(p => ({ ...p, shells: { ...p.shells, [rank]: p.shells[rank] - SHELLS[rank].itemCost } }));
setGachaRank(rank); setGachaType('item'); setGachaPhase('spin');
let r = Math.random(), idx = 0;
ITEM_RATES[rank].forEach((rate, i) => { if (r > 0) { r -= rate; if (r <= 0) idx = i; } });
const item = ITEMS[rank][idx];
setGachaRarity(item.rarity);
const t = getTiming(item.rarity);
setTimeout(() => {
if (t.build > 0) { setGachaPhase('build'); sound('gachaRare'); setTimeout(() => finishItem(item), t.build); }
else finishItem(item);
}, t.spin);
};

const finishItem = (item) => {
setGachaPhase('result');
sound('gachaHit');
const idx = player.items.findIndex(x => x.id === item.id);
if (idx >= 0) {
const newLv = Math.min(10, (player.items[idx].lv || 1) + 1);
const newItems = [...player.items]; newItems[idx] = { ...newItems[idx], lv: newLv };
setPlayer(p => ({ ...p, items: newItems }));
setResult({ ...item, lv: newLv, isUp: true });
} else {
setPlayer(p => ({ ...p, items: [...p.items, { ...item, lv: 1 }] }));
setResult({ ...item, lv: 1, isUp: false });
}
};

const pullJob = (rank) => {
if (player.shells[rank] < SHELLS[rank].jobCost) return;
sound('gacha');
setPlayer(p => ({ ...p, shells: { ...p.shells, [rank]: p.shells[rank] - SHELLS[rank].jobCost } }));
setGachaRank(rank); setGachaType('job'); setGachaPhase('spin');
const byR = {}; Object.entries(JOBS).forEach(([id, j]) => { byR[j.rarity] = byR[j.rarity] || []; byR[j.rarity].push(id); });
let r = Math.random(), rarity = 'N';
Object.entries(JOB_RATES[rank] || {}).forEach(([ra, rate]) => { if (r > 0) { r -= rate; if (r <= 0) rarity = ra; } });
const jobId = byR[rarity]?.[Math.floor(Math.random() * (byR[rarity]?.length || 1))] || 'fisherman';
setGachaRarity(JOBS[jobId].rarity);
const t = getTiming(JOBS[jobId].rarity);
setTimeout(() => {
if (t.build > 0) { setGachaPhase('build'); sound('gachaRare'); setTimeout(() => finishJob(jobId), t.build); }
else finishJob(jobId);
}, t.spin);
};

const finishJob = (jobId) => {
setGachaPhase('result');
sound('gachaHit');
const isNew = !player.unlockedJobs.includes(jobId);
const newLv = Math.min(10, (player.jobLevels[jobId] || 0) + 1);
setPlayer(p => ({
...p,
unlockedJobs: isNew ? [...p.unlockedJobs, jobId] : p.unlockedJobs,
jobLevels: { ...p.jobLevels, [jobId]: newLv },
}));
setResult({ type: 'job', jobId, job: JOBS[jobId], lv: newLv, isNew });
};

const closeResult = () => { setResult(null); setGachaPhase(null); setGachaRarity(null); };

const handlePw = () => {
const d = decode(pwInput);
if (d) { setPlayer(d); setHp(null); setPwError(''); setShowPwInput(false); setPwInput(''); setScreen('home'); sound('levelup'); }
else setPwError('ã˜ã‚…ã‚‚ã‚“ãŒ ã¡ãŒã„ã¾ã™');
};

const ri = RARITY_LIST.indexOf(gachaRarity || 'N');

// ã‚¿ã‚¤ãƒˆãƒ«
if (screen === 'title') return (
<div style={{
minHeight: '100vh',
background: 'linear-gradient(180deg, #000510 0%, #001030 30%, #002855 60%, #004080 100%)',
fontFamily: '"Hiragino Kaku Gothic Pro", "Yu Gothic", sans-serif',
display: 'flex',
flexDirection: 'column',
alignItems: 'center',
justifyContent: 'center',
position: 'relative',
overflow: 'hidden',
}}>
{/* æµ·ã®æ³¢ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */}
<div style={{ position: 'absolute', bottom: 0, left: 0, right: 0, height: '30%', background: 'linear-gradient(180deg, transparent 0%, rgba(0,100,180,0.3) 50%, rgba(0,150,220,0.4) 100%)', animation: 'wave 4s ease-in-out infinite' }} />
<div style={{ position: 'absolute', bottom: 0, left: 0, right: 0, height: '25%', background: 'linear-gradient(180deg, transparent 0%, rgba(0,80,150,0.2) 50%, rgba(0,120,200,0.3) 100%)', animation: 'wave 3s ease-in-out infinite reverse' }} />

  {/* æµ®éŠã™ã‚‹æ³¡ */}
  {[...Array(15)].map((_, i) => (
    <div key={i} style={{
      position: 'absolute',
      width: 8 + Math.random() * 15,
      height: 8 + Math.random() * 15,
      borderRadius: '50%',
      background: 'radial-gradient(circle at 30% 30%, rgba(255,255,255,0.4), rgba(100,200,255,0.1))',
      left: `${5 + Math.random() * 90}%`,
      bottom: `${Math.random() * 40}%`,
      animation: `bubble ${4 + Math.random() * 4}s ease-in-out infinite`,
      animationDelay: `${Math.random() * 3}s`,
    }} />
  ))}
  
  {/* å…‰ã®ç­‹ */}
  <div style={{ position: 'absolute', top: 0, left: '20%', width: '2px', height: '60%', background: 'linear-gradient(180deg, rgba(255,255,255,0.3), transparent)', transform: 'rotate(15deg)', animation: 'shimmer 3s ease-in-out infinite' }} />
  <div style={{ position: 'absolute', top: 0, left: '70%', width: '2px', height: '50%', background: 'linear-gradient(180deg, rgba(255,255,255,0.2), transparent)', transform: 'rotate(-10deg)', animation: 'shimmer 4s ease-in-out infinite 1s' }} />
  
  {/* ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ« */}
  {showPwInput && (
    <div style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.9)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 100 }}>
      <div style={{ background: 'linear-gradient(135deg, #0a1525 0%, #1a2a45 100%)', padding: 30, borderRadius: 20, border: '2px solid #FFD700', boxShadow: '0 0 40px rgba(255,215,0,0.3)', width: '90%', maxWidth: 380 }}>
        <div style={{ color: '#FFD700', fontSize: 20, textAlign: 'center', marginBottom: 20, textShadow: '0 0 10px rgba(255,215,0,0.5)' }}>ğŸ“œ ãµã£ã‹ã¤ã®ã˜ã‚…ã‚‚ã‚“</div>
        <textarea value={pwInput} onChange={e => setPwInput(e.target.value)} placeholder="ã˜ã‚…ã‚‚ã‚“ã‚’ ã«ã‚…ã†ã‚Šã‚‡ã..." style={{ width: '100%', height: 110, padding: 12, fontSize: 15, background: 'rgba(0,0,0,0.5)', border: '2px solid #4169E1', borderRadius: 10, color: '#fff', resize: 'none', boxSizing: 'border-box' }} />
        {pwError && <div style={{ color: '#ff6b6b', fontSize: 13, textAlign: 'center', marginTop: 10 }}>{pwError}</div>}
        <div style={{ display: 'flex', gap: 12, marginTop: 20 }}>
          <button onClick={() => { setShowPwInput(false); setPwInput(''); setPwError(''); }} style={{ flex: 1, padding: 12, background: 'rgba(100,100,100,0.5)', border: '1px solid #666', borderRadius: 10, color: '#fff', cursor: 'pointer', fontSize: 15 }}>ã‚‚ã©ã‚‹</button>
          <button onClick={handlePw} style={{ flex: 1, padding: 12, background: 'linear-gradient(135deg, #FFD700 0%, #FFA500 100%)', border: 'none', borderRadius: 10, color: '#1a1a2e', fontWeight: 'bold', cursor: 'pointer', fontSize: 15, boxShadow: '0 4px 15px rgba(255,215,0,0.4)' }}>ã‘ã£ã¦ã„</button>
        </div>
      </div>
    </div>
  )}
  
  {/* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */}
  <div style={{ position: 'relative', zIndex: 10, textAlign: 'center', padding: '0 20px' }}>
    {/* ã‚¢ã‚¤ã‚³ãƒ³ç¾¤ */}
    <div style={{ display: 'flex', justifyContent: 'center', gap: 8, marginBottom: 25 }}>
      <span style={{ fontSize: 45, animation: 'float 3s ease-in-out infinite', filter: 'drop-shadow(0 0 10px rgba(255,200,100,0.5))' }}>ğŸš</span>
      <span style={{ fontSize: 55, animation: 'float 3s ease-in-out infinite 0.3s', filter: 'drop-shadow(0 0 15px rgba(100,200,255,0.6))' }}>ğŸ‰</span>
      <span style={{ fontSize: 45, animation: 'float 3s ease-in-out infinite 0.6s', filter: 'drop-shadow(0 0 10px rgba(255,100,100,0.5))' }}>ğŸ¦ˆ</span>
    </div>
    
    {/* ãƒ¡ã‚¤ãƒ³ã‚¿ã‚¤ãƒˆãƒ« */}
    <h1 style={{ 
      fontSize: 44, 
      fontWeight: 900,
      color: 'transparent',
      background: 'linear-gradient(180deg, #FFE566 0%, #FFD700 30%, #FF9500 70%, #FF6B00 100%)',
      backgroundClip: 'text',
      WebkitBackgroundClip: 'text',
      textShadow: '0 0 40px rgba(255,180,0,0.6), 0 4px 8px rgba(0,0,0,0.5)',
      marginBottom: 8,
      letterSpacing: 6,
      lineHeight: 1.2,
    }}>
      éš å²æµ·ä¼èª¬
    </h1>
    
    {/* è‹±èªã‚µãƒ– */}
    <div style={{
      fontSize: 11,
      color: '#87CEEB',
      letterSpacing: 8,
      marginBottom: 15,
      opacity: 0.8,
    }}>
      OKI OCEAN SAGA
    </div>
    
    {/* ã‚µãƒ–ã‚¿ã‚¤ãƒˆãƒ« */}
    <div style={{
      fontSize: 15,
      color: '#fff',
      textShadow: '0 0 20px rgba(100,200,255,0.5)',
      marginBottom: 8,
      letterSpacing: 2,
    }}>
      ã€œ ç¥ã€…ã®çœ ã‚‹æµ·ã§ã€ä¼èª¬ã‚’ç¶™ã’ ã€œ
    </div>
    
    {/* ã‚­ãƒ£ãƒƒãƒã‚³ãƒ”ãƒ¼ */}
    <div style={{
      fontSize: 11,
      color: '#aaa',
      marginBottom: 40,
      letterSpacing: 1,
    }}>
      è²ã‚’é›†ã‚ã€è·æ¥­ã‚’æ¥µã‚ã€é¾ç¥ã®åŠ›ã‚’æ‰‹ã«å…¥ã‚Œã‚
    </div>
    
    {/* ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ */}
    <button 
      onClick={() => { sound('button'); setScreen('home'); }} 
      style={{ 
        padding: '18px 60px', 
        fontSize: 20, 
        fontWeight: 'bold',
        background: 'linear-gradient(180deg, #FFE566 0%, #FFD700 40%, #FF9500 100%)',
        border: 'none', 
        borderRadius: 50, 
        color: '#1a0a00',
        cursor: 'pointer', 
        marginBottom: 20,
        boxShadow: '0 6px 30px rgba(255,180,0,0.5), inset 0 2px 0 rgba(255,255,255,0.3)',
        letterSpacing: 4,
        transition: 'all 0.2s ease',
        position: 'relative',
        overflow: 'hidden',
      }}
      onMouseOver={(e) => { e.target.style.transform = 'scale(1.05)'; e.target.style.boxShadow = '0 8px 40px rgba(255,180,0,0.7)'; }}
      onMouseOut={(e) => { e.target.style.transform = 'scale(1)'; e.target.style.boxShadow = '0 6px 30px rgba(255,180,0,0.5)'; }}
    >
      âš”ï¸ å†’é™ºã‚’ã¯ã˜ã‚ã‚‹
    </button>
    
    {/* ã˜ã‚…ã‚‚ã‚“ãƒœã‚¿ãƒ³ */}
    <div>
      <button 
        onClick={() => { sound('button'); setShowPwInput(true); }} 
        style={{ 
          padding: '12px 35px', 
          fontSize: 13, 
          background: 'rgba(255,255,255,0.05)', 
          border: '2px solid rgba(135,206,235,0.5)', 
          borderRadius: 25, 
          color: '#87CEEB', 
          cursor: 'pointer',
          backdropFilter: 'blur(10px)',
          transition: 'all 0.2s ease',
        }}
        onMouseOver={(e) => { e.target.style.background = 'rgba(135,206,235,0.15)'; e.target.style.borderColor = '#87CEEB'; }}
        onMouseOut={(e) => { e.target.style.background = 'rgba(255,255,255,0.05)'; e.target.style.borderColor = 'rgba(135,206,235,0.5)'; }}
      >
        ğŸ“œ ãµã£ã‹ã¤ã®ã˜ã‚…ã‚‚ã‚“
      </button>
    </div>
    
    {/* ãƒ•ãƒƒã‚¿ãƒ¼ */}
    <div style={{ marginTop: 50, fontSize: 10, color: 'rgba(255,255,255,0.3)', letterSpacing: 1 }}>
      ğŸï¸ SHIMANEãƒ»OKI ISLANDS ğŸï¸
    </div>
  </div>
  
  {/* ã‚¿ã‚¤ãƒˆãƒ«ç”¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */}
  <style>{`
    @keyframes wave {
      0%, 100% { transform: translateY(0) translateX(0); }
      50% { transform: translateY(-15px) translateX(10px); }
    }
    @keyframes bubble {
      0%, 100% { transform: translateY(0) scale(1); opacity: 0.6; }
      50% { transform: translateY(-80px) scale(1.1); opacity: 0.3; }
    }
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-12px); }
    }
    @keyframes shimmer {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 0.6; }
    }
  `}</style>
</div>

);

// ãƒãƒˆãƒ«
if (screen === 'battle') return (
<div style={{ minHeight: '100vh', background: 'linear-gradient(180deg,#0a1628,#1a3a5c)', fontFamily: 'sans-serif', padding: 15 }}>
<div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 15 }}>
<div style={{ background: 'rgba(0,0,0,0.5)', padding: 10, borderRadius: 10, border: `2px solid ${job.color}` }}>
<div style={{ color: job.color, fontSize: 12 }}>{job.icon} {job.name} JLv{jLv} / PLv{player.level}</div>
<div style={{ width: 120, height: 12, background: '#222', borderRadius: 6, overflow: 'hidden', marginTop: 5 }}>
<div style={{ width: `${curHp / maxHp * 100}%`, height: '100%', background: '#f44' }} />
</div>
<div style={{ color: '#fff', fontSize: 10 }}>HP:{curHp}/{maxHp} æ”»:{stats.atk} é˜²:{stats.def}</div>
</div>
<button onClick={() => { sound('button'); setEnemy(null); setLog([]); setScreen('home'); }} style={{ padding: '8px 15px', background: '#555', border: 'none', borderRadius: 15, color: '#fff', cursor: 'pointer', fontSize: 12 }}>é€ƒã’ã‚‹</button>
</div>

  {enemy && (
    <div style={{ textAlign: 'center', marginBottom: 20 }}>
      {enemy.boss && (
        <div style={{ color: enemy.glow, fontSize: 14, fontWeight: 'bold', marginBottom: 5, textShadow: `0 0 10px ${enemy.glow}` }}>
          âš ï¸ BOSS âš ï¸
        </div>
      )}
      <div style={{ 
        fontSize: 80, 
        filter: enemy.boss ? `drop-shadow(0 0 30px ${enemy.glow}) drop-shadow(0 0 60px ${enemy.glow})` : `drop-shadow(0 0 20px ${enemy.color})`,
        animation: enemy.boss ? 'bossPulse 1s infinite' : 'none'
      }}>{enemy.icon}</div>
      <div style={{ color: enemy.boss ? enemy.glow : '#fff', fontSize: 16, fontWeight: enemy.boss ? 'bold' : 'normal' }}>{enemy.name}</div>
      <div style={{ width: 150, height: 12, background: '#222', borderRadius: 6, overflow: 'hidden', margin: '5px auto', border: enemy.boss ? `2px solid ${enemy.glow}` : 'none' }}>
        <div style={{ width: `${enemy.hp / enemy.maxHp * 100}%`, height: '100%', background: enemy.boss ? enemy.glow : enemy.color }} />
      </div>
      <div style={{ color: '#aaa', fontSize: 11 }}>HP:{enemy.hp}/{enemy.maxHp} æ”»:{enemy.atk} é˜²:{enemy.def}</div>
    </div>
  )}
  
  {!enemy && log.length > 0 && <div style={{ textAlign: 'center', fontSize: 50, marginBottom: 20 }}>{curHp > 0 ? 'ğŸ‰' : 'ğŸ’€'}</div>}
  
  <div style={{ background: 'rgba(0,0,0,0.5)', borderRadius: 10, padding: 10, minHeight: 100, marginBottom: 15 }}>
    {log.map((l, i) => <div key={i} style={{ 
      color: l.includes('å‹åˆ©') || l.includes('ã‚¢ãƒƒãƒ—') ? '#FFD700' : l.includes('æ•—åŒ—') ? '#f44' : l.includes('ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«') ? '#FF69B4' : l.includes('BOSS') ? '#FF4500' : '#fff', 
      fontSize: 13, padding: 2 
    }}>{l}</div>)}
  </div>
  
  <div style={{ display: 'flex', gap: 10, justifyContent: 'center' }}>
    {enemy ? (
      <button onClick={doAttack} disabled={anim} style={{ padding: '15px 40px', fontSize: 18, background: anim ? '#555' : '#f44', border: 'none', borderRadius: 25, color: '#fff', fontWeight: 'bold', cursor: anim ? 'default' : 'pointer' }}>âš”ï¸ æ”»æ’ƒ</button>
    ) : (
      <>
        <button onClick={startBattle} disabled={curHp <= 0} style={{ padding: '12px 25px', fontSize: 14, background: curHp <= 0 ? '#555' : '#4169E1', border: 'none', borderRadius: 20, color: '#fff', cursor: curHp <= 0 ? 'default' : 'pointer' }}>ğŸŒŠ æ¬¡ã¸</button>
        <button onClick={() => { sound('button'); setScreen('home'); }} style={{ padding: '12px 25px', fontSize: 14, background: '#228B22', border: 'none', borderRadius: 20, color: '#fff', cursor: 'pointer' }}>ğŸ  æˆ»ã‚‹</button>
      </>
    )}
  </div>
  
  <style>{`
    @keyframes bossPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
  `}</style>
</div>

);

// ãƒ›ãƒ¼ãƒ 
return (
<div style={{ minHeight: '100vh', background: 'linear-gradient(180deg,#1a1a2e,#16213e)', fontFamily: 'sans-serif', padding: 12 }}>
{/* ã‚¬ãƒãƒ£æ¼”å‡º */}
{(gachaPhase === 'spin' || gachaPhase === 'build') && (
<div style={{ position: 'fixed', inset: 0, background: gachaPhase === 'build' ? `radial-gradient(circle,${RARITY_COLOR[gachaRarity]}44,#000)` : '#000', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 100 }}>
{gachaPhase === 'spin' && <div style={{ fontSize: 100, animation: 'spin 1s linear infinite' }}>{gachaType === 'job' ? 'ğŸ‘¤' : SHELLS[gachaRank]?.icon}</div>}
{gachaPhase === 'build' && (
<div style={{ textAlign: 'center', position: 'relative' }}>
{ri >= 2 && <div style={{ position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%,-50%)', width: 200, height: 200, border: `3px solid ${RARITY_COLOR[gachaRarity]}`, borderRadius: '50%', borderTopColor: 'transparent', animation: 'spin 1s linear infinite' }} />}
{ri >= 4 && <div style={{ position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%,-50%)', width: 250, height: 250, background: 'conic-gradient(red,yellow,lime,aqua,blue,magenta,red)', borderRadius: '50%', animation: 'spin 2s linear infinite', opacity: 0.3, filter: 'blur(10px)' }} />}
<div style={{ fontSize: 80, position: 'relative', animation: ri >= 3 ? 'shake 0.1s infinite' : 'pulse 0.5s infinite', filter: `drop-shadow(0 0 30px ${RARITY_COLOR[gachaRarity]})` }}>â“</div>
<div style={{ color: RARITY_COLOR[gachaRarity], fontSize: 20, marginTop: 20, fontWeight: 'bold' }}>
{ri >= 5 ? 'ï¼ï¼ä¼èª¬ã®è¼ãï¼ï¼' : ri >= 4 ? 'ï¼ç¥ã€…ã—ã„å…‰ï¼' : ri >= 3 ? 'é‡‘è‰²ã®å…‰ãŒï¼' : 'ç´«ã®å…‰...'}
</div>
</div>
)}
</div>
)}

  {/* çµæœè¡¨ç¤º */}
  {result && gachaPhase === 'result' && (
    <div style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.95)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 100 }}>
      <div style={{ textAlign: 'center', padding: 20 }}>
        {result.type === 'job' ? (
          <>
            {result.isNew ? <div style={{ color: '#0f0', fontSize: 18, marginBottom: 10 }}>ğŸ†• NEW!</div> : <div style={{ color: '#0ff', fontSize: 18, marginBottom: 10 }}>â¬†ï¸ ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼</div>}
            <div style={{ color: RARITY_COLOR[result.job.rarity], fontSize: 18 }}>â˜…{result.job.rarity}â˜…</div>
            <div style={{ fontSize: 80, margin: '15px 0', filter: `drop-shadow(0 0 30px ${result.job.color})` }}>{result.job.icon}</div>
            <div style={{ color: '#fff', fontSize: 24, marginBottom: 5 }}>{result.job.name}</div>
            <div style={{ color: '#FFD700', fontSize: 20 }}>è·æ¥­Lv.{result.lv}</div>
            <div style={{ color: '#aaa', fontSize: 12, marginTop: 10 }}>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹+{((result.lv - 1) * 15)}% / ç‰¹æ®ŠåŠ¹æœ+{15 + (result.lv - 1) * 8}%</div>
          </>
        ) : (
          <>
            {result.isUp ? <div style={{ color: '#0ff', fontSize: 18, marginBottom: 10 }}>â¬†ï¸ ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼</div> : <div style={{ color: '#0f0', fontSize: 18, marginBottom: 10 }}>ğŸ†• NEW!</div>}
            <div style={{ color: RARITY_COLOR[result.rarity], fontSize: 18 }}>â˜…{result.rarity}â˜…</div>
            <div style={{ fontSize: 60, margin: '15px 0' }}>{TYPE_ICON[result.type]}</div>
            <div style={{ color: '#888', fontSize: 12 }}>{TYPE_NAME[result.type]}</div>
            <div style={{ color: '#fff', fontSize: 22, marginBottom: 5 }}>{result.name}</div>
            <div style={{ color: '#FFD700', fontSize: 18 }}>Lv.{result.lv}</div>
            <div style={{ color: '#aaa', fontSize: 12, marginTop: 10 }}>
              æ”»+{Math.floor(result.atk * (1 + (result.lv - 1) * 0.25))} é˜²+{Math.floor(result.def * (1 + (result.lv - 1) * 0.25))} HP+{Math.floor(result.hp * (1 + (result.lv - 1) * 0.25))}
            </div>
          </>
        )}
        <button onClick={() => { sound('button'); closeResult(); }} style={{ marginTop: 25, padding: '12px 40px', background: '#FFD700', border: 'none', borderRadius: 20, fontWeight: 'bold', cursor: 'pointer' }}>OK</button>
      </div>
    </div>
  )}

  {/* ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¡¨ç¤º */}
  {showPw && (
    <div style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.9)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 100 }}>
      <div style={{ background: '#1a1a2e', padding: 25, borderRadius: 15, border: '2px solid #FFD700', width: '90%', maxWidth: 400, textAlign: 'center' }}>
        <div style={{ color: '#FFD700', fontSize: 18, marginBottom: 15 }}>ğŸ“œ ãµã£ã‹ã¤ã®ã˜ã‚…ã‚‚ã‚“</div>
        <div style={{ background: '#0a0a1a', padding: 15, borderRadius: 8, marginBottom: 15 }}>
          <div style={{ color: '#fff', fontSize: 16, fontFamily: 'monospace', wordBreak: 'break-all', lineHeight: 1.8 }}>{encode(player)}</div>
        </div>
        <div style={{ color: '#888', fontSize: 11, marginBottom: 15 }}>Lv{player.level} / è·æ¥­{player.unlockedJobs.length}ç¨® / è£…å‚™{player.items.length}å€‹</div>
        <button onClick={() => navigator.clipboard?.writeText(encode(player))} style={{ padding: '8px 20px', background: '#4169E1', border: 'none', borderRadius: 15, color: '#fff', cursor: 'pointer', marginRight: 10 }}>ã‚³ãƒ”ãƒ¼</button>
        <button onClick={() => { sound('button'); setShowPw(false); }} style={{ padding: '8px 20px', background: '#FFD700', border: 'none', borderRadius: 15, fontWeight: 'bold', cursor: 'pointer' }}>ã¨ã˜ã‚‹</button>
      </div>
    </div>
  )}

  {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 12, flexWrap: 'wrap', gap: 8 }}>
    <div style={{ background: 'rgba(0,0,0,0.5)', padding: 10, borderRadius: 10, border: `2px solid ${job.color}`, display: 'flex', alignItems: 'center', gap: 10 }}>
      <span style={{ fontSize: 24 }}>{job.icon}</span>
      <div>
        <div style={{ color: job.color, fontSize: 11 }}>{job.name} JLv{jLv}</div>
        <div style={{ color: '#FFD700', fontSize: 14, fontWeight: 'bold' }}>PLv{player.level}</div>
      </div>
    </div>
    <div style={{ display: 'flex', gap: 6 }}>
      <button onClick={() => { sound('button'); setShowPw(true); }} style={{ padding: '8px 12px', background: 'rgba(255,215,0,0.2)', border: '1px solid #FFD700', borderRadius: 15, color: '#FFD700', cursor: 'pointer', fontSize: 11 }}>ğŸ“œ</button>
      <button onClick={() => { sound('heal'); setHp(maxHp); }} style={{ padding: '8px 12px', background: '#00CED1', border: 'none', borderRadius: 15, color: '#fff', cursor: 'pointer', fontSize: 11 }}>ğŸ’šå›å¾©</button>
      <button onClick={startBattle} disabled={curHp <= 0} style={{ padding: '8px 12px', background: curHp <= 0 ? '#555' : '#f44', border: 'none', borderRadius: 15, color: '#fff', cursor: curHp <= 0 ? 'default' : 'pointer', fontSize: 11 }}>âš”ï¸æˆ¦é—˜</button>
    </div>
  </div>

  {/* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */}
  <div style={{ background: 'rgba(0,0,0,0.4)', borderRadius: 10, padding: 10, marginBottom: 12 }}>
    <div style={{ color: '#fff', fontSize: 12, marginBottom: 5 }}>HP:{curHp}/{maxHp} æ”»:{stats.atk} é˜²:{stats.def}</div>
    <div style={{ width: '100%', height: 6, background: '#222', borderRadius: 3, overflow: 'hidden' }}>
      <div style={{ width: `${curHp / maxHp * 100}%`, height: '100%', background: '#f44' }} />
    </div>
  </div>

  {/* è²ï¼ˆåå‰è¡¨ç¤ºè¿½åŠ ï¼‰ */}
  <div style={{ display: 'flex', gap: 4, marginBottom: 12, flexWrap: 'wrap' }}>
    {Object.entries(SHELLS).map(([r, s]) => (
      <div key={r} style={{ background: `${s.color}22`, border: `1px solid ${s.color}`, borderRadius: 8, padding: '6px 8px', textAlign: 'center', minWidth: 55, flex: '1 1 auto' }}>
        <div style={{ fontSize: 18 }}>{s.icon}</div>
        <div style={{ color: s.color, fontSize: 10, fontWeight: 'bold' }}>{s.name}</div>
        <div style={{ color: '#fff', fontSize: 16, fontWeight: 'bold' }}>{player.shells[r]}</div>
      </div>
    ))}
  </div>

  {/* ã‚¿ãƒ– */}
  <div style={{ display: 'flex', gap: 4, marginBottom: 12 }}>
    {[['gacha', 'ğŸ°ã‚¬ãƒãƒ£'], ['jobs', 'ğŸ‘¤è·æ¥­'], ['items', 'ğŸ“¦è£…å‚™']].map(([id, label]) => (
      <button key={id} onClick={() => { sound('button'); setTab(id); }} style={{ flex: 1, padding: 10, background: tab === id ? '#4169E1' : '#333', border: tab === id ? '2px solid #87CEEB' : '2px solid #444', borderRadius: 8, color: '#fff', fontSize: 12, cursor: 'pointer' }}>{label}</button>
    ))}
  </div>

  {/* ã‚¬ãƒãƒ£ã‚¿ãƒ– */}
  {tab === 'gacha' && (
    <div style={{ background: 'rgba(0,0,0,0.4)', borderRadius: 10, padding: 12 }}>
      <div style={{ color: '#FFD700', fontSize: 13, marginBottom: 8, fontWeight: 'bold' }}>ğŸ° è£…å‚™ã‚¬ãƒãƒ£</div>
      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(5,1fr)', gap: 6, marginBottom: 15 }}>
        {Object.entries(SHELLS).map(([r, s]) => {
          const can = player.shells[r] >= s.itemCost;
          return <button key={r} onClick={() => can && pullItem(+r)} disabled={!can} style={{ padding: 6, background: can ? s.color : '#333', border: 'none', borderRadius: 8, color: '#fff', opacity: can ? 1 : 0.5, cursor: can ? 'pointer' : 'default' }}>
            <div style={{ fontSize: 16 }}>{s.icon}</div>
            <div style={{ fontSize: 8 }}>{s.name}</div>
            <div style={{ fontSize: 9, marginTop: 2 }}>{s.itemCost}å€‹</div>
          </button>;
        })}
      </div>
      <div style={{ color: '#9932CC', fontSize: 13, marginBottom: 8, fontWeight: 'bold' }}>ğŸ‘¤ è·æ¥­ã‚¬ãƒãƒ£</div>
      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(5,1fr)', gap: 6 }}>
        {Object.entries(SHELLS).map(([r, s]) => {
          const can = player.shells[r] >= s.jobCost;
          return <button key={r} onClick={() => can && pullJob(+r)} disabled={!can} style={{ padding: 6, background: can ? '#9932CC' : '#333', border: 'none', borderRadius: 8, color: '#fff', opacity: can ? 1 : 0.5, cursor: can ? 'pointer' : 'default' }}>
            <div style={{ fontSize: 16 }}>ğŸ‘¤</div>
            <div style={{ fontSize: 8 }}>{s.name}</div>
            <div style={{ fontSize: 9, marginTop: 2 }}>{s.jobCost}å€‹</div>
          </button>;
        })}
      </div>
    </div>
  )}

  {/* è·æ¥­ã‚¿ãƒ– */}
  {tab === 'jobs' && (
    <div style={{ background: 'rgba(0,0,0,0.4)', borderRadius: 10, padding: 12 }}>
      <div style={{ color: '#9932CC', fontSize: 13, marginBottom: 10, fontWeight: 'bold' }}>ğŸ‘¤ è·æ¥­ ({player.unlockedJobs.length}/10)</div>
      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2,1fr)', gap: 8, maxHeight: 350, overflowY: 'auto' }}>
        {Object.entries(JOBS).map(([id, j]) => {
          const unlocked = player.unlockedJobs.includes(id);
          const active = player.currentJob === id;
          const lv = player.jobLevels[id] || 1;
          return <button key={id} onClick={() => { if (unlocked) { sound('button'); setPlayer(p => ({ ...p, currentJob: id })); }}} disabled={!unlocked} style={{ padding: 10, background: active ? j.color : unlocked ? `${j.color}33` : '#222', border: active ? '2px solid #FFD700' : '1px solid #444', borderRadius: 8, color: '#fff', opacity: unlocked ? 1 : 0.4, cursor: unlocked ? 'pointer' : 'default', textAlign: 'left' }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
              <span style={{ fontSize: 24 }}>{unlocked ? j.icon : 'â“'}</span>
              <div>
                <div style={{ fontSize: 10, color: RARITY_COLOR[j.rarity] }}>{j.rarity}</div>
                <div style={{ fontSize: 12, fontWeight: 'bold' }}>{unlocked ? j.name : '???'}</div>
                {unlocked && <div style={{ fontSize: 10, color: '#FFD700' }}>Lv{lv}</div>}
              </div>
            </div>
            {active && <div style={{ fontSize: 9, color: '#FFD700', marginTop: 5 }}>â–¶ä½¿ç”¨ä¸­</div>}
          </button>;
        })}
      </div>
    </div>
  )}

  {/* è£…å‚™ã‚¿ãƒ– */}
  {tab === 'items' && (
    <div style={{ background: 'rgba(0,0,0,0.4)', borderRadius: 10, padding: 12 }}>
      <div style={{ color: '#FFD700', fontSize: 13, marginBottom: 10, fontWeight: 'bold' }}>ğŸ“¦ è£…å‚™ ({player.items.length})</div>
      {player.items.length === 0 ? <div style={{ color: '#666', textAlign: 'center', padding: 20 }}>è£…å‚™ãªã—</div> : (
        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2,1fr)', gap: 8, maxHeight: 350, overflowY: 'auto' }}>
          {player.items.map((it, i) => {
            const b = 1 + ((it.lv || 1) - 1) * 0.25;
            return <div key={i} style={{ background: `${RARITY_COLOR[it.rarity]}22`, border: `1px solid ${RARITY_COLOR[it.rarity]}`, borderRadius: 8, padding: 8 }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: 6 }}>
                <span style={{ fontSize: 20 }}>{TYPE_ICON[it.type]}</span>
                <div>
                  <div style={{ fontSize: 9, color: RARITY_COLOR[it.rarity] }}>{it.rarity} {TYPE_NAME[it.type]}</div>
                  <div style={{ fontSize: 11, color: '#fff' }}>{it.name}</div>
                  <div style={{ fontSize: 10, color: '#FFD700' }}>Lv{it.lv || 1}</div>
                </div>
              </div>
              <div style={{ fontSize: 9, color: '#aaa', marginTop: 5 }}>
                æ”»+{Math.floor(it.atk * b)} é˜²+{Math.floor(it.def * b)} HP+{Math.floor(it.hp * b)}
              </div>
            </div>;
          })}
        </div>
      )}
    </div>
  )}

  <style>{`
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    @keyframes pulse { 0%,100% { transform: scale(1); } 50% { transform: scale(1.1); } }
    @keyframes shake { 0%,100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
  `}</style>
</div>

);
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<Game />);
    </script>
  </body>
</html>
