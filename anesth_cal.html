<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>麻酔点数計算システム</title>
<style>
  /* --- 基本スタイル & リセット --- */
  :root {
    --primary-color: #3498db;
    --secondary-color: #2c3e50;
    --light-gray: #f8f9fa;
    --border-color: #bdc3c7;
  }

  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  body {
    font-family: 'Segoe UI', 'Meiryo', 'ヒラギノ角ゴ Pro W3', sans-serif;
    margin: 0;
    padding: 15px;
    background: #f0f2f5;
    font-size: 13px;
    color: var(--secondary-color);
  }

  .container {
    max-width: 210mm; /* A4 width */
    margin: 0 auto;
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    padding: 20px;
  }

  h2 {
    text-align: center;
    color: var(--secondary-color);
    margin-bottom: 20px;
    font-size: 22px;
    font-weight: 600;
    border-bottom: 2px solid var(--primary-color);
    padding-bottom: 10px;
  }

  input, select, button {
    font-family: inherit;
    font-size: 100%;
  }

  /* --- 上部セクション: 患者情報 & コントロール --- */
  .top-section {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
  }

  .patient-info {
    background: var(--light-gray);
    border-radius: 5px;
    padding: 15px;
    border-left: 4px solid var(--primary-color);
  }

  .patient-info h3 {
    margin-bottom: 12px;
    font-size: 16px;
  }

  .info-grid {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 8px 12px;
    align-items: center;
  }

  .info-grid label {
    font-weight: 500;
  }

  .info-grid input {
    padding: 6px 8px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
  }

  .control-panel {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .category-info {
    background: #e9ecef;
    padding: 10px;
    border-radius: 4px;
    font-size: 12px;
    line-height: 1.5;
  }

  .difficulty-select {
    display: flex;
    flex-direction: column;
    gap: 5px;
  }

  .difficulty-select label {
    font-weight: 500;
  }

  select, input[type="text"] {
    width: 100%;
    padding: 6px 8px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    transition: border-color 0.2s, box-shadow 0.2s;
  }

  select:focus, input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
  }
  
  /* --- 時間入力セクション --- */
  .time-section {
    margin-bottom: 20px;
  }

  .time-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
  }

  .time-table {
    width: 100%;
    border-collapse: collapse;
    border: 1px solid var(--border-color);
    border-radius: 5px;
    overflow: hidden;
  }

  .time-table th, .time-table td {
    padding: 6px;
    text-align: center;
    font-size: 12px;
  }

  .time-table th {
    background: var(--primary-color);
    color: white;
    font-weight: 500;
  }
  
  .time-table td {
    border-top: 1px solid #e9ecef;
  }

  .time-table tbody tr:nth-child(even) {
    background-color: var(--light-gray);
  }

  .time-table input {
    width: 100%;
    max-width: 60px;
    padding: 4px;
    text-align: center;
    border: 1px solid transparent;
    border-radius: 3px;
    background: transparent;
  }

  .time-table input:focus {
    background: white;
    border: 1px solid var(--primary-color);
  }
  
  /* --- 追加項目セクション --- */
  .additional-sections {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
  }

  .additional-section {
    background: var(--light-gray);
    border-radius: 5px;
    padding: 15px;
    border: 1px solid #e9ecef;
  }

  .additional-section h4 {
    margin-bottom: 10px;
    font-size: 16px;
  }

  .checkbox-group {
    margin-bottom: 10px;
  }

  .checkbox-group label {
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
  }

  .inline-inputs {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 8px;
    align-items: center;
  }
  
  .small-text {
    font-size: 11px;
    color: #6c757d;
    margin-top: 8px;
  }

  /* --- 下部セクション: ボタン & 結果 --- */
  .bottom-section {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 20px;
    margin-top: 10px;
  }

  .calc-button {
    background: #27ae60;
    color: white;
    border: none;
    padding: 10px 25px;
    border-radius: 5px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.2s, transform 0.2s;
  }

  .calc-button:hover {
    background: #2ecc71;
    transform: translateY(-2px);
  }
  
  .result-section {
    flex-grow: 1;
    background: #e8f5e9;
    border-radius: 5px;
    padding: 10px 15px;
    border-left: 4px solid #28a745;
    display: none; /* JSで表示を切り替え */
  }

  .result-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 4px 0;
  }

  .result-item:last-child {
    font-weight: bold;
    font-size: 14px;
    border-top: 1px solid rgba(40, 167, 69, 0.4);
    padding-top: 6px;
    margin-top: 4px;
  }

  .result-value {
    font-weight: bold;
    color: #155724;
  }
  
  /* --- エラーポップアップ --- */
  .overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.6);
    z-index: 999;
  }
  .error-popup {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    border-radius: 8px;
    padding: 25px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    z-index: 1000;
    width: 90%;
    max-width: 400px;
  }
  .error-popup h3 {
    color: #e74c3c;
    margin-bottom: 10px;
  }
  .error-popup p {
    margin-bottom: 20px;
  }
  .error-popup button {
    background: #e74c3c;
    color: white;
    border: none;
    padding: 8px 20px;
    border-radius: 5px;
    cursor: pointer;
    float: right;
  }

  /* --- 印刷用スタイル --- */
  @media print {
    @page {
      size: A4 portrait;
      margin: 15mm;
    }

    body {
      background: white !important;
      padding: 0;
      font-size: 10pt; /* 印刷に適した単位とサイズ */
    }

    .container {
      box-shadow: none;
      border: none;
      padding: 0;
      width: 100%;
      max-width: 100%;
    }
    
    /* 印刷に不要なUIを非表示 */
    .calc-button, .overlay, .error-popup {
      display: none !important;
    }
    
    /* レイアウトのギャップを詰める */
    .top-section, .time-grid, .additional-sections, .bottom-section {
      gap: 10px;
      margin-bottom: 10px;
    }

    /* 背景色やボーダーを印刷用に調整 */
    .patient-info, .additional-section, .time-table tbody tr:nth-child(even) {
      background: none !important;
    }
    .patient-info, .additional-section, .result-section {
      border: 1px solid #ccc;
      border-left-width: 3px;
    }
    .time-table th {
      background: #eee !important;
      color: black !important;
      border-bottom: 2px solid black;
    }
    .time-table, .time-table td {
      border: 1px solid #ccc;
    }
    
    /* 結果は必ず表示 */
    .result-section {
      display: block !important;
      background: #f5f5f5 !important;
    }

    /* 入力値が見えるように */
    input, select {
      border: 1px solid #ddd !important;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }
  }
</style>
</head>
<body>

<div class="container">
  <h2>麻酔点数計算システム <span style="font-size: 12px; color: #7f8c8d; font-weight: 400;">by myGEMS</span></h2>

  <div class="top-section">
    <div class="patient-info">
      <h3>患者情報</h3>
      <div class="info-grid">
        <label for="surgeryDate">日付:</label>
        <input type="date" id="surgeryDate">
        <label for="patientId">患者ID:</label>
        <input type="text" id="patientId" placeholder="12345">
        <label for="patientName">氏名:</label>
        <input type="text" id="patientName" placeholder="ヤマダ タロウ">
        <label for="surgeryType">術式:</label>
        <input type="text" id="surgeryType" placeholder="腹腔鏡下胆嚢摘出術">
      </div>
    </div>

    <div class="control-panel">
      <div class="category-info">
        <strong>区分3:</strong> 腹臥位<br>
        <strong>区分4:</strong> 腹腔鏡・側臥位<br>
        <strong>区分5:</strong> 通常体位
      </div>
      <div class="difficulty-select">
        <label for="iOrRoSelect">麻酔困難度:</label>
        <select id="iOrRoSelect">
          <option value="">選択してください</option>
          <option value="イ">イ（困難）</option>
          <option value="ロ">ロ（通常）</option>
        </select>
      </div>
    </div>
  </div>

  <div class="time-section">
    <div class="time-grid">
      <table class="time-table">
        <thead>
          <tr><th>行</th><th>開始</th><th>終了</th><th>区分</th></tr>
        </thead>
        <tbody>
          <tr><td>1</td><td><input type="text" id="start1" oninput="updateNextStart(1)" placeholder="0900"></td><td><input type="text" id="end1" oninput="updateNextStart(1)" placeholder="1200"></td><td><input type="text" id="cat1" placeholder="5"></td></tr>
          <tr><td>2</td><td><input type="text" id="start2" oninput="updateNextStart(2)"></td><td><input type="text" id="end2" oninput="updateNextStart(2)"></td><td><input type="text" id="cat2"></td></tr>
          <tr><td>3</td><td><input type="text" id="start3" oninput="updateNextStart(3)"></td><td><input type="text" id="end3" oninput="updateNextStart(3)"></td><td><input type="text" id="cat3"></td></tr>
          <tr><td>4</td><td><input type="text" id="start4" oninput="updateNextStart(4)"></td><td><input type="text" id="end4" oninput="updateNextStart(4)"></td><td><input type="text" id="cat4"></td></tr>
          <tr><td>5</td><td><input type="text" id="start5" oninput="updateNextStart(5)"></td><td><input type="text" id="end5" oninput="updateNextStart(5)"></td><td><input type="text" id="cat5"></td></tr>
        </tbody>
      </table>

      <table class="time-table">
        <thead>
          <tr><th>行</th><th>開始</th><th>終了</th><th>区分</th></tr>
        </thead>
        <tbody>
          <tr><td>6</td><td><input type="text" id="start6" oninput="updateNextStart(6)"></td><td><input type="text" id="end6" oninput="updateNextStart(6)"></td><td><input type="text" id="cat6"></td></tr>
          <tr><td>7</td><td><input type="text" id="start7" oninput="updateNextStart(7)"></td><td><input type="text" id="end7" oninput="updateNextStart(7)"></td><td><input type="text" id="cat7"></td></tr>
          <tr><td>8</td><td><input type="text" id="start8" oninput="updateNextStart(8)"></td><td><input type="text" id="end8" oninput="updateNextStart(8)"></td><td><input type="text" id="cat8"></td></tr>
          <tr><td>9</td><td><input type="text" id="start9" oninput="updateNextStart(9)"></td><td><input type="text" id="end9" oninput="updateNextStart(9)"></td><td><input type="text" id="cat9"></td></tr>
          <tr><td>10</td><td><input type="text" id="start10" oninput="updateNextStart(10)"></td><td><input type="text" id="end10" oninput="updateNextStart(10)"></td><td><input type="text" id="cat10"></td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="additional-sections">
    <div class="additional-section">
      <h4>硬膜外麻酔</h4>
      <div class="checkbox-group">
        <label><input type="checkbox" id="chkEA"> 実施あり</label>
      </div>
      <div class="inline-inputs">
        <label>部位:</label> <input type="text" id="eaType" placeholder="1">
        <label>開始:</label> <input type="text" id="eaStart" placeholder="0900">
        <label>終了:</label> <input type="text" id="eaEnd" placeholder="1200">
      </div>
      <div class="small-text">1=頸胸, 2=腰, 3=仙骨</div>
    </div>

    <div class="additional-section">
      <h4>神経ブロック</h4>
      <div class="checkbox-group">
        <label><input type="checkbox" id="chkNB"> 実施あり</label>
      </div>
      <select id="nbType">
        <option value="">選択してください</option>
        <option value="イ">イ（450点）</option>
        <option value="ロ">ロ（45点）</option>
      </select>
      <div class="small-text">硬膜外代替=イ、その他=ロ</div>
    </div>
  </div>

  <div class="bottom-section">
    <button class="calc-button" onclick="calcFee()">計算実行</button>

    <div class="result-section" id="resultSection">
      <div class="result-item">
        <span class="result-label">麻酔管理料 (合計):</span>
        <span class="result-value" id="resultArea">0 点</span>
      </div>
      <div class="result-item">
        <span class="result-label">対価報酬額 (8円/点):</span>
        <span class="result-value" id="feeAmount">0 円</span>
      </div>
    </div>
  </div>
</div>

<script>
// (JavaScript部分は変更なしのため、元のコードをそのままここに配置してください)
// ... 元の <script> タグ内のコードをここにペースト ...
// エラーポップアップ表示
function showError(title, message) {
  const overlay = document.createElement('div');
  overlay.className = 'overlay';
  
  const popup = document.createElement('div');
  popup.className = 'error-popup';
  popup.innerHTML = `
    <h3>${title}</h3>
    <p>${message}</p>
    <button onclick="closeError()">OK</button>
  `;
  
  document.body.appendChild(overlay);
  document.body.appendChild(popup);
  
  window.currentErrorElements = { overlay, popup };
}

function closeError() {
  if (window.currentErrorElements) {
    document.body.removeChild(window.currentErrorElements.overlay);
    document.body.removeChild(window.currentErrorElements.popup);
    window.currentErrorElements = null;
  }
}

// 時刻バリデーション
function validateTime(timeStr) {
  if (!timeStr || timeStr.trim() === '') return null;
  
  const cleaned = timeStr.replace(/\D/g, '');
  if (cleaned.length !== 4) {
    return { error: '時刻は4桁で入力してください（例: 0900）' };
  }
  
  const hours = parseInt(cleaned.substring(0, 2));
  const minutes = parseInt(cleaned.substring(2, 4));
  
  if (hours < 0 || hours > 23) {
    return { error: '時間は00-23の範囲で入力してください' };
  }
  
  if (minutes < 0 || minutes > 59) {
    return { error: '分は00-59の範囲で入力してください' };
  }
  
  return { hours, minutes, totalMinutes: hours * 60 + minutes };
}

// 終了時刻を入力したら次の行の開始時刻に自動入力
function updateNextStart(currentRow) {
  const endTime = document.getElementById("end" + currentRow).value;
  if (endTime && endTime.length === 4) {
    const nextRow = currentRow + 1;
    if (nextRow <= 10) {
      const nextStartField = document.getElementById("start" + nextRow);
      if (nextStartField && !nextStartField.value) {
        nextStartField.value = endTime;
      }
    }
  }
}

/**
 * メイン計算処理
 */
function calcFee() {
  // 1) イ/ロ選択チェック
  const iOrRo = document.getElementById("iOrRoSelect").value;
  if (iOrRo !== "イ" && iOrRo !== "ロ") {
    showError("入力エラー", "麻酔困難患者の区分（イ/ロ）を選択してください。");
    return;
  }

  // 2) 時間入力の検証と集計
  let dic = {};
  let totalGAMin = 0;
  let hasValidEntry = false;

  for (let i = 1; i <= 10; i++) {
    const startVal = document.getElementById("start" + i).value.trim();
    const endVal = document.getElementById("end" + i).value.trim();
    const catVal = document.getElementById("cat" + i).value.trim();

    // 空欄の場合はスキップ
    if (!startVal && !endVal && !catVal) continue;

    // 部分的な入力チェック
    if ((startVal || endVal || catVal) && (!startVal || !endVal || !catVal)) {
      showError("入力エラー", `${i}行目: 開始時刻、終了時刻、区分をすべて入力してください。`);
      return;
    }

    // 時刻バリデーション
    const startTime = validateTime(startVal);
    const endTime = validateTime(endVal);

    if (startTime && startTime.error) {
      showError("時刻入力エラー", `${i}行目の開始時刻: ${startTime.error}`);
      return;
    }

    if (endTime && endTime.error) {
      showError("時刻入力エラー", `${i}行目の終了時刻: ${endTime.error}`);
      return;
    }

    // 区分チェック
    const catNum = parseInt(catVal, 10);
    if (isNaN(catNum) || (catNum !== 3 && catNum !== 4 && catNum !== 5)) {
      showError("区分入力エラー", `${i}行目: 区分は3、4、5のいずれかを入力してください。`);
      return;
    }

    // 時間の論理チェック
    if (startTime.totalMinutes >= endTime.totalMinutes) {
      showError("時間エラー", `${i}行目: 終了時刻は開始時刻より後の時刻を入力してください。`);
      return;
    }

    const duration = endTime.totalMinutes - startTime.totalMinutes;
    totalGAMin += duration;
    hasValidEntry = true;

    if (!dic[catNum]) dic[catNum] = 0;
    dic[catNum] += duration;
  }

  // 有効な入力がない場合
  if (!hasValidEntry) {
    showError("入力エラー", "麻酔時間を最低1行は入力してください。");
    return;
  }

  // 20分未満チェック
  if (totalGAMin < 20) {
    showError("時間エラー", "全身麻酔時間が20分未満です。算定できません。");
    return;
  }

  // 3) 点数計算
  let arr = [];
  for (const catNumStr in dic) {
    let catNo = parseInt(catNumStr, 10);
    let timeMin = dic[catNumStr];
    let basePt = getBasePoints(catNo, iOrRo);
    arr.push({ catNo, timeMin, basePt });
  }

  arr.sort((a, b) => b.basePt - a.basePt);

  let remain120 = 120;
  let basePoints = 0;
  let overArray = [];

  for (let i = 0; i < arr.length; i++) {
    let item = arr[i];
    if (remain120 > 0) {
      if (item.timeMin >= remain120) {
        if (basePoints === 0) basePoints = item.basePt;
        let overPart = item.timeMin - remain120;
        remain120 = 0;
        if (overPart > 0) {
          overArray.push({ catNo: item.catNo, timeMin: overPart });
        }
      } else {
        if (basePoints === 0) basePoints = item.basePt;
        remain120 -= item.timeMin;
      }
    } else {
      overArray.push({ catNo: item.catNo, timeMin: item.timeMin });
    }
  }

  // 4) 2時間超過部分
  let manageTimeAdd = 0;
  overArray.forEach(oitem => {
    let unitAdd = getManageTimeAddUnit(oitem.catNo);
    let blocks = Math.floor(oitem.timeMin / 30);
    if (oitem.timeMin % 30 > 0) blocks++;
    manageTimeAdd += (blocks * unitAdd);
  });

  let anesthesiaPoints = basePoints + manageTimeAdd;

  // 5) 硬膜外麻酔
  let epBase = 0, epTimeAdd = 0;
  if (document.getElementById("chkEA").checked) {
    const eaTypeVal = parseInt(document.getElementById("eaType").value.trim(), 10);
    if (isNaN(eaTypeVal) || eaTypeVal < 1 || eaTypeVal > 3) {
      showError("硬膜外麻酔エラー", "部位は1（頸胸）、2（腰）、3（仙骨）のいずれかを入力してください。");
      return;
    }

    const eaStartTime = validateTime(document.getElementById("eaStart").value.trim());
    const eaEndTime = validateTime(document.getElementById("eaEnd").value.trim());

    if (eaStartTime && eaStartTime.error) {
      showError("硬膜外麻酔時刻エラー", `開始時刻: ${eaStartTime.error}`);
      return;
    }

    if (eaEndTime && eaEndTime.error) {
      showError("硬膜外麻酔時刻エラー", `終了時刻: ${eaEndTime.error}`);
      return;
    }

    if (eaStartTime && eaEndTime) {
      if (eaStartTime.totalMinutes >= eaEndTime.totalMinutes) {
        showError("硬膜外麻酔時間エラー", "終了時刻は開始時刻より後の時刻を入力してください。");
        return;
      }

      epBase = getEpiduralBaseAdd(eaTypeVal);
      const eaDuration = eaEndTime.totalMinutes - eaStartTime.totalMinutes;
      if (eaDuration > 120) {
        const overEA = eaDuration - 120;
        epTimeAdd = getEpiduralTimeAdd(eaTypeVal, overEA);
      }
    }
  }

  // 6) 神経ブロック
  let nbAdd = 0;
  if (document.getElementById("chkNB").checked) {
    const nbType = document.getElementById("nbType").value.trim();
    if (!nbType) {
      showError("神経ブロックエラー", "神経ブロックの区分（イ/ロ）を選択してください。");
      return;
    }
    nbAdd = getNerveBlockAdd(nbType);
  }

  // 7) 結果表示
  const totalPoints = anesthesiaPoints + epBase + epTimeAdd + nbAdd;
  const feeAmount = totalPoints * 8;

  document.getElementById("resultArea").innerText = totalPoints.toLocaleString() + " 点";
  document.getElementById("feeAmount").innerText = feeAmount.toLocaleString() + " 円";
  document.getElementById("resultSection").style.display = "block";
}

// 基本点数計算関数群（変更なし）
function getBasePoints(catNo, iOrRo) {
  if (catNo === 3) return (iOrRo === "イ") ? 12610 : 9170;
  if (catNo === 4) return (iOrRo === "イ") ? 9130 : 6610;
  if (catNo === 5) return (iOrRo === "イ") ? 8300 : 6000;
  return 0;
}

function getManageTimeAddUnit(catNo) {
  switch (catNo) {
    case 3: return 900;
    case 4: return 660;
    case 5: return 600;
    default: return 0;
  }
}

function getEpiduralBaseAdd(eaType) {
  switch (eaType) {
    case 1: return 750;
    case 2: return 400;
    case 3: return 170;
    default: return 0;
  }
}

function getEpiduralTimeAdd(eaType, overMin) {
  let unit = 0;
  if (eaType === 1) unit = 375;
  else if (eaType === 2) unit = 200;
  else if (eaType === 3) unit = 85;

  let blocks = Math.floor(overMin / 30);
  if (overMin % 30 > 0) blocks++;
  return blocks * unit;
}

function getNerveBlockAdd(nbType) {
  if (nbType === "イ") return 450;
  if (nbType === "ロ") return 45;
  return 0;
}
</script>

</body>
</html>
